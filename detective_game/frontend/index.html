<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>LLM 侦探原型</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background: #f7f9fb;
      }
      header h1 {
        margin: 0 0 1rem;
      }
      section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      #actions button {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        padding: 0.6rem 1rem;
      }
      #log {
        max-height: 260px;
        overflow-y: auto;
        border-left: 3px solid #4a90e2;
        padding-left: 1rem;
      }
      .event {
        margin-bottom: 0.8rem;
      }
      .meta {
        color: #555;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>LLM 侦探原型</h1>
      <p>每回合选择一个动作，观察 NPC 的回应，逐步揭开真相。</p>
    </header>

    <section id="state">
      <h2>当前状态</h2>
      <p id="turn"></p>
      <p id="location"></p>
      <p id="clues"></p>
    </section>

    <section id="actions">
      <h2>可执行动作</h2>
      <div id="action-buttons"></div>
    </section>

    <section id="log">
      <h2>最近事件</h2>
      <div id="event-list"></div>
    </section>

    <script>
      const API_BASE = "http://127.0.0.1:8000";

      async function fetchState() {
        const res = await fetch(`${API_BASE}/api/state`);
        if (!res.ok) {
          console.error("获取状态失败");
          return;
        }
        const data = await res.json();
        renderState(data);
      }

      async function postAction(action) {
        const res = await fetch(`${API_BASE}/api/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(action),
        });
        if (!res.ok) {
          alert("执行动作失败");
          return;
        }
        const data = await res.json();
        renderState(data);
      }

      function renderState(state) {
        document.getElementById("turn").textContent = `回合：${state.turn}，时间：${state.current_time}`;
        document.getElementById("location").textContent = `当前位置：${state.player_location}`;
        document.getElementById("clues").textContent = `线索：${
          state.clues && state.clues.length ? state.clues.join(", ") : "暂无线索"
        }`;

        const actionBox = document.getElementById("action-buttons");
        actionBox.textContent = "";
        (state.available_actions || []).forEach((action) => {
          const btn = document.createElement("button");
          btn.textContent = action.label;
          btn.onclick = () =>
            postAction({ type: action.type, target: action.target, metadata: action.metadata || {} });
          actionBox.appendChild(btn);
        });

        const eventList = document.getElementById("event-list");
        eventList.textContent = "";
        (state.events || []).forEach((event) => {
          const div = document.createElement("div");
          div.className = "event";
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `[${event.event_type}] ${event.actor || "系统"} @ ${event.location || "N/A"}`;
          const text = document.createElement("div");
          text.textContent = event.text;
          div.appendChild(meta);
          div.appendChild(text);
          eventList.appendChild(div);
        });
      }

      fetchState();
    </script>
  </body>
</html>
