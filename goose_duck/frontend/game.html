<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLM é¹…é¸­æ€ - æ¸¸æˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(circle at top left, #1f2b45, #0b1220);
      color: #e8ecf5;
      min-height: 100vh;
    }
    .card {
      background: rgba(20, 28, 47, 0.9);
      border-color: #1f2a44;
    }
    .phase-badge {
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-weight: 600;
    }
    .card,
    .card-body,
    .card-header {
      color: #f5f7ff;
    }
    .text-secondary,
    .text-muted,
    .small {
      color: #d5ddf0 !important;
    }
    .action-btn {
      width: 100%;
      text-align: left;
    }
    .action-move { border-left: 4px solid #4ecdc4; }
    .action-kill { border-left: 4px solid #e74c3c; }
    .action-report { border-left: 4px solid #e67e22; }
    .action-emergency { border-left: 4px solid #f1c40f; }
    .action-vote { border-left: 4px solid #9b59b6; }
    .action-talk { border-left: 4px solid #f39c12; }
    .player-dead { opacity: 0.6; text-decoration: line-through; }
  </style>
</head>
<body>
  <div class="container-fluid py-3">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <div class="fs-4 fw-bold">ğŸ¦¢ LLM é¹…é¸­æ€</div>
      <div class="d-flex align-items-center gap-2">
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" id="role-btn" data-bs-toggle="dropdown">æˆ‘çš„èº«ä»½</button>
          <div class="dropdown-menu dropdown-menu-end p-3 text-dark" id="role-dropdown" style="min-width:240px;">
            <div id="role-content" class="small text-muted">èº«ä»½æœªçŸ¥</div>
          </div>
        </div>
        <a class="btn btn-outline-info btn-sm" href="map.html">æŸ¥çœ‹åœ°å›¾</a>
        <button class="btn btn-outline-warning btn-sm" onclick="resetGame()">é‡æ–°å¼€å§‹</button>
      </div>
    </header>

    <div id="start-screen" class="d-flex flex-column align-items-center justify-content-center" style="min-height:60vh;">
      <h2 class="mb-3">ğŸ¦¢ vs ğŸ¦†</h2>
      <p class="text-secondary text-center mb-4">åœ¨é£èˆ¹ä¸Šæ¨ç†ã€æ¬ºéª—å¹¶ç”Ÿå­˜ä¸‹æ¥ã€‚ç‚¹å‡»å¼€å§‹æ¸¸æˆã€‚</p>
      <button class="btn btn-success btn-lg" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <div id="game-layout" class="row g-3 d-none">
      <div class="col-lg-3">
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>ç©å®¶çŠ¶æ€</span>
          <span class="badge bg-secondary" id="alive-count">0/0</span>
        </div>
          <div class="card-body" id="players-list" style="max-height:65vh; overflow-y:auto;"></div>
        </div>
        <div class="card">
          <div class="card-header">æˆ‘çš„ä¿¡æ¯</div>
          <div class="card-body" id="my-info">
            <div class="text-muted small">ç­‰å¾…å¼€å§‹...</div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold" id="room-name">ğŸ“ æœªçŸ¥æˆ¿é—´</div>
              <div class="text-secondary small" id="room-desc">...</div>
            </div>
            <div class="text-end">
              <div class="phase-badge bg-dark text-light" id="phase-badge">ç­‰å¾…å¼€å§‹</div>
              <div class="small" id="round-display">å›åˆ 0</div>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="fw-semibold mb-2">åœ¨åœºäººå‘˜</div>
              <div class="d-flex flex-wrap gap-2" id="players-here"></div>
            </div>
            <div>
              <div class="fw-semibold mb-2">å¯æ‰§è¡ŒåŠ¨ä½œ</div>
              <div class="d-grid gap-2" id="actions-grid" style="grid-template-columns: repeat(3, 1fr);"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card h-100">
          <div class="card-header">äº‹ä»¶æ—¥å¿—</div>
          <div class="card-body" id="event-log" style="overflow-y:auto; max-height:75vh;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = "http://127.0.0.1:8000";
    let gameState = null;
    let autoShowRole = false;

    async function fetchState() {
      try {
        const res = await fetch(`${API_BASE}/api/state`);
        const data = await res.json();
        if (data.error) {
          showStart();
          return;
        }
        gameState = data;
        showGame();
        renderGame();
      } catch (err) {
        console.error("è·å–çŠ¶æ€å¤±è´¥:", err);
        showStart();
      }
    }

    async function startGame() {
      try {
        const res = await fetch(`${API_BASE}/api/start`, { method: "POST" });
        gameState = await res.json();
        autoShowRole = true;
        showGame();
        renderGame();
      } catch (err) {
        alert("å¼€å§‹æ¸¸æˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯");
        console.error(err);
      }
    }

    async function doAction(action) {
      try {
        const res = await fetch(`${API_BASE}/api/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(action),
        });
        gameState = await res.json();
        renderGame();
      } catch (err) {
        console.error("æ‰§è¡ŒåŠ¨ä½œå¤±è´¥:", err);
      }
    }

    async function resetGame() {
      try {
        await fetch(`${API_BASE}/api/reset`, { method: "POST" });
        gameState = null;
        autoShowRole = false;
        showStart();
      } catch (err) {
        console.error("é‡ç½®å¤±è´¥:", err);
      }
    }

    function showStart() {
      document.getElementById("start-screen").classList.remove("d-none");
      document.getElementById("game-layout").classList.add("d-none");
    }

    function showGame() {
      document.getElementById("start-screen").classList.add("d-none");
      document.getElementById("game-layout").classList.remove("d-none");
    }

    function renderGame() {
      if (!gameState) return;

      // Phase
      const phaseBadge = document.getElementById("phase-badge");
      const phaseLabels = {
        "lobby": "ç­‰å¾…å¼€å§‹",
        "free_roam": "ğŸš€ è‡ªç”±æ´»åŠ¨",
        "discussion": "ğŸ—£ï¸ è®¨è®ºä¸­",
        "voting": "ğŸ—³ï¸ æŠ•ç¥¨ä¸­",
        "game_over": "æ¸¸æˆç»“æŸ",
      };
      phaseBadge.textContent = phaseLabels[gameState.phase] || gameState.phase;
      phaseBadge.className = "phase-badge bg-dark text-light";
      if (gameState.phase === "free_roam") phaseBadge.classList.add("bg-success", "text-dark");
      if (gameState.phase === "discussion") phaseBadge.classList.add("bg-warning", "text-dark");
      if (gameState.phase === "voting") phaseBadge.classList.add("bg-danger");
      if (gameState.phase === "game_over") phaseBadge.classList.add("bg-secondary");
      document.getElementById("round-display").textContent = `å›åˆ ${gameState.round}`;

      // My role dropdown
      if (gameState.player?.role) renderRole(gameState.player.role, gameState.player.can_kill);

      // Players list
      const playersList = document.getElementById("players-list");
      playersList.innerHTML = "";
      (gameState.all_players || []).forEach(p => {
        const item = document.createElement("div");
        item.className = "d-flex align-items-center mb-2 p-2 rounded " + (p.is_alive ? "bg-dark-subtle" : "bg-dark-subtle player-dead");
        item.innerHTML = `
          <div class="me-2 fs-5">${p.avatar || "ğŸ‘¤"}</div>
          <div>
            <div class="fw-semibold">${p.name} ${p.id === "player" ? "(ä½ )" : ""}</div>
            <div class="text-secondary small">${p.is_alive ? "å­˜æ´»" : "æ­»äº¡"} Â· ${p.location || "-"}</div>
          </div>
        `;
        item.onclick = () => renderPlayerDetail(p);
        playersList.appendChild(item);
      });
      const alive = (gameState.all_players || []).filter(p => p.is_alive).length;
      document.getElementById("alive-count").textContent = `${alive}/${gameState.all_players?.length || 0}`;

      // Room info
      if (gameState.current_room) {
        document.getElementById("room-name").textContent = "ğŸ“ " + gameState.current_room.name;
        document.getElementById("room-desc").textContent = gameState.current_room.description || "";
      }
      const playersHere = document.getElementById("players-here");
      playersHere.innerHTML = "";
      (gameState.players_here || []).forEach(p => {
        const badge = document.createElement("span");
        badge.className = "badge bg-secondary-subtle text-black";
        badge.textContent = `${p.avatar || "ğŸ‘¤"} ${p.name}`;
        badge.onclick = () => renderPlayerDetail(p);
        playersHere.appendChild(badge);
      });
      if ((gameState.players_here || []).length === 0) {
        playersHere.innerHTML = '<span class="text-secondary">è¿™é‡Œåªæœ‰ä½ ä¸€ä¸ªäºº</span>';
      }

      // Actions
      const actionsGrid = document.getElementById("actions-grid");
      actionsGrid.innerHTML = "";
      if ((gameState.available_actions || []).length === 0) {
        actionsGrid.innerHTML = '<div class="text-secondary">æš‚æ— å¯ç”¨åŠ¨ä½œ</div>';
      } else {
        (gameState.available_actions || []).forEach(action => {
          const btn = document.createElement("button");
          btn.className = "btn btn-outline-light action-btn action-" + action.type;
          btn.textContent = action.label;
          btn.onclick = () => doAction(action);
          actionsGrid.appendChild(btn);
        });
      }

      // Events
      renderEvents(gameState.events || []);

      if (gameState.phase === "game_over") {
        alert(gameState.winner_reason || "æ¸¸æˆç»“æŸ");
      }
    }

    function renderRole(role, canKill) {
      const dropdown = document.getElementById("role-dropdown");
      const content = document.getElementById("role-content");
      const teamLabels = { good: "å¥½äººé˜µè¥", evil: "åäººé˜µè¥", neutral: "ä¸­ç«‹é˜µè¥" };
      const roleEmoji = { goose: "ğŸ¦¢", sheriff: "ğŸ”", vigilante: "ğŸ—¡ï¸", canadian: "ğŸ", dodo: "ğŸ¦¤", assassin: "ğŸ¯" };
      content.innerHTML = `
        <div class="d-flex align-items-center gap-2 mb-2">
          <div class="fs-4">${roleEmoji[role.role_type] || "â“"}</div>
          <div>
            <div class="fw-semibold">${role.name}</div>
            <div class="text-secondary small">${teamLabels[role.team] || role.team}</div>
          </div>
        </div>
        <div class="text-secondary small mb-2">${role.description}</div>
        ${canKill ? '<div class="text-danger small">ğŸ”ª å¯ä»¥å‡»æ€</div>' : ''}
      `;
      if (autoShowRole) {
        dropdown.classList.add("show");
        autoShowRole = false;
        setTimeout(() => dropdown.classList.remove("show"), 2000);
      }
    }

    function renderPlayerDetail(p) {
      const myInfo = document.getElementById("my-info");
      myInfo.innerHTML = `
        <div class="fw-bold mb-1">${p.name}</div>
        <div class="text-secondary small mb-1">çŠ¶æ€ï¼š${p.is_alive ? "å­˜æ´»" : "æ­»äº¡"}</div>
        <div class="text-secondary small mb-1">ä½ç½®ï¼š${p.location || "-"}</div>
        <div class="text-secondary small mb-1">æœ€è¿‘åŠ¨ä½œï¼š${p.last_action || "æœªçŸ¥"}</div>
      `;
    }

    function renderEvents(events) {
      const eventLog = document.getElementById("event-log");
      eventLog.innerHTML = "";
      (events || []).forEach(ev => {
        const div = document.createElement("div");
        div.className = "mb-2 p-2 rounded border border-secondary-subtle";
        div.textContent = ev.text;
        eventLog.appendChild(div);
      });
      eventLog.scrollTop = eventLog.scrollHeight;
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchState();
    });
  </script>
</body>
</html>
