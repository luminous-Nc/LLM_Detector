<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LLM Goose Duck Game - Play</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(circle at top left, #1f2b45, #0b1220);
      color: #e8ecf5;
      min-height: 100vh;
    }
    .card {
      background: rgba(20, 28, 47, 0.9);
      border-color: #1f2a44;
    }
    .phase-badge {
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-weight: 600;
    }
    .card,
    .card-body,
    .card-header {
      color: #f5f7ff;
    }
    .text-secondary,
    .text-muted,
    .small {
      color: #d5ddf0 !important;
    }
    .action-btn {
      width: 100%;
      text-align: left;
    }
    .action-move { border-left: 4px solid #4ecdc4; }
    .action-kill { border-left: 4px solid #e74c3c; }
    .action-report { border-left: 4px solid #e67e22; }
    .action-emergency { border-left: 4px solid #f1c40f; }
    .action-vote { border-left: 4px solid #9b59b6; }
    .action-talk { border-left: 4px solid #f39c12; }
    .player-dead { opacity: 0.6; text-decoration: line-through; }
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      color: #e8ecf5;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loading-overlay">Other players are thinking and acting...</div>
  <div class="container-fluid py-3">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <div class="fs-4 fw-bold">ü¶¢ LLM Goose Duck Game</div>
      <div class="d-flex align-items-center gap-2">
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" id="role-btn" data-bs-toggle="dropdown">My Identity</button>
          <div class="dropdown-menu dropdown-menu-end p-3 text-dark" id="role-dropdown" style="min-width:240px;">
            <div id="role-content" class="small text-muted">Identity unknown</div>
          </div>
        </div>
        <a class="btn btn-outline-info btn-sm" href="map.html">View Map</a>
        <button class="btn btn-outline-warning btn-sm" onclick="resetGame()">Reset Game</button>
      </div>
    </header>

    <div id="start-screen" class="d-flex flex-column align-items-center justify-content-center" style="min-height:60vh;">
      <h2 class="mb-3">ü¶¢ vs ü¶Ü</h2>
      <p class="text-secondary text-center mb-4">Reason, deceive, and survive on the spaceship. Click to start the game.</p>
      <button class="btn btn-success btn-lg" onclick="startGame()">Start Game</button>
    </div>

    <div id="game-layout" class="row g-3 d-none">
      <div class="col-lg-3">
        <div class="card h-100">
          <div class="card-header">My Info</div>
          <div class="card-body" id="my-info" style="overflow-y:auto; max-height:85vh;">
            <div class="text-muted small">Waiting to start...</div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold" id="room-name">üìç Unknown Room</div>
              <div class="text-secondary small" id="room-desc">...</div>
            </div>
            <div class="text-end">
              <div class="phase-badge bg-dark text-light" id="phase-badge">Waiting to start</div>
              <div class="small" id="round-display">Round 0</div>
            </div>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="fw-semibold mb-2">People Here</div>
              <div class="d-flex flex-wrap gap-2" id="players-here"></div>
            </div>
            <div>
              <div class="fw-semibold mb-2">Available Actions</div>
              <div class="d-grid gap-2" id="actions-grid" style="grid-template-columns: repeat(3, 1fr);"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="card h-100">
          <div class="card-header">Event Log</div>
          <div class="card-body" id="event-log" style="overflow-y:auto; max-height:75vh;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = "http://127.0.0.1:8000";
    let gameState = null;
    let autoShowRole = false;
    let overlayTimeout = null;

    async function fetchState() {
      try {
        const res = await fetch(`${API_BASE}/api/state`);
        const data = await res.json();
        if (data.error) {
          showStart();
          return;
        }
        gameState = data;
        showGame();
        renderGame();
        if (gameState.phase === "discussion" || gameState.phase === "voting") {
          window.location.href = "meeting.html";
          return;
        }
      } catch (err) {
        console.error("Failed to fetch state:", err);
        showStart();
      }
    }

    async function startGame() {
      try {
        const res = await fetch(`${API_BASE}/api/start`, { method: "POST" });
        gameState = await res.json();
        autoShowRole = true;
        showGame();
        renderGame();
      } catch (err) {
        alert("Failed to start game, please check the backend");
        console.error(err);
      }
    }

    async function doAction(action) {
      try {
        document.getElementById("loading-overlay").style.display = "flex";
        const res = await fetch(`${API_BASE}/api/action`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(action),
        });
        gameState = await res.json();
        renderGame();
        if (gameState.phase === "discussion" || gameState.phase === "voting") {
          window.location.href = "meeting.html";
          return;
        }
      } catch (err) {
        console.error("Failed to execute action:", err);
      } finally {
        document.getElementById("loading-overlay").style.display = "none";
      }
    }

    async function resetGame() {
      try {
        await fetch(`${API_BASE}/api/reset`, { method: "POST" });
        gameState = null;
        autoShowRole = false;
        showStart();
      } catch (err) {
        console.error("Reset failed:", err);
      }
    }

    async function startChat(targetId) {
      try {
        const res = await fetch(`${API_BASE}/api/chat/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ target_id: targetId }),
        });
        const data = await res.json();
        if (data.error) {
          alert(data.error);
          return;
        }
        window.location.href = "chat.html";
      } catch (err) {
        console.error("Failed to start conversation:", err);
      }
    }

    function showStart() {
      document.getElementById("start-screen").classList.remove("d-none");
      document.getElementById("game-layout").classList.add("d-none");
    }

    function showGame() {
      document.getElementById("start-screen").classList.add("d-none");
      document.getElementById("game-layout").classList.remove("d-none");
    }

    function showOverlayOnceIfNeeded() {
      const overlay = document.getElementById("loading-overlay");
      if (localStorage.getItem("showOverlayAfterChat") === "true") {
        overlay.style.display = "flex";
        localStorage.removeItem("showOverlayAfterChat");
        clearTimeout(overlayTimeout);
        overlayTimeout = setTimeout(() => {
          overlay.style.display = "none";
        }, 1800);
      }
    }

    function renderGame() {
      if (!gameState) return;

      // Phase
      const phaseBadge = document.getElementById("phase-badge");
      const phaseLabels = {
        "lobby": "Waiting to start",
        "free_roam": "üöÄ Free Roam",
        "discussion": "üó£Ô∏è Discussion",
        "voting": "üó≥Ô∏è Voting",
        "game_over": "Game Over",
      };
      phaseBadge.textContent = phaseLabels[gameState.phase] || gameState.phase;
      phaseBadge.className = "phase-badge bg-dark text-light";
      if (gameState.phase === "free_roam") phaseBadge.classList.add("bg-success", "text-dark");
      if (gameState.phase === "discussion") phaseBadge.classList.add("bg-warning", "text-dark");
      if (gameState.phase === "voting") phaseBadge.classList.add("bg-danger");
      if (gameState.phase === "game_over") phaseBadge.classList.add("bg-secondary");
      document.getElementById("round-display").textContent = `Round ${gameState.round}`;

      // My role dropdown
      if (gameState.player?.role) renderRole(gameState.player.role, gameState.player.can_kill);
      // My info (tasks + known deaths)
      const myInfo = document.getElementById("my-info");
      if (gameState.player?.tasks) {
        const tasks = gameState.player.tasks.map(t => {
          const p = t.progress || 0;
          const label = p >= 2 ? "Completed" : p === 1 ? "1/2" : "Not started";
          const loc = t.location_name || t.location || "Unknown location";
          return `<div class="d-flex justify-content-between small text-secondary border-bottom border-secondary-subtle py-1">
              <span>${t.name}</span>
              <span>${loc} ¬∑ ${label}</span>
            </div>`;
        }).join("");
        const deaths = (gameState.known_deaths || []).map(d => {
          const loc = d.location_name || d.location || "";
          return `<div class="small text-danger">‚ò†Ô∏è ${d.name}${loc ? " @ " + loc : ""}</div>`;
        }).join("");
        myInfo.innerHTML = `
          <div class="fw-semibold mb-1">${gameState.player.name}</div>
          <div class="text-secondary small mb-3">${gameState.player.role?.name || "Unknown identity"}</div>
          <div class="fw-semibold mb-1">Task Progress</div>
          ${tasks || '<div class="text-secondary small">No tasks</div>'}
          <div class="fw-semibold mt-3 mb-1">Known Deaths</div>
          ${deaths || '<div class="text-secondary small">None found</div>'}
        `;
      }

      // Room info
      if (gameState.current_room) {
        document.getElementById("room-name").textContent = "üìç " + gameState.current_room.name;
        document.getElementById("room-desc").textContent = gameState.current_room.description || "";
      }
      const playersHere = document.getElementById("players-here");
      playersHere.innerHTML = "";
      (gameState.players_here || []).forEach(p => {
        const badge = document.createElement("span");
        badge.className = "badge bg-secondary-subtle text-black";
        badge.textContent = `${p.avatar || "üë§"} ${p.name}`;
        badge.onclick = () => renderPlayerDetail(p);
        playersHere.appendChild(badge);
      });
      if ((gameState.players_here || []).length === 0) {
        playersHere.innerHTML = '<span class="text-secondary">You are alone here</span>';
      }

      // Actions
      const actionsGrid = document.getElementById("actions-grid");
      actionsGrid.innerHTML = "";
      if ((gameState.available_actions || []).length === 0) {
        actionsGrid.innerHTML = '<div class="text-secondary">No available actions</div>';
      } else {
        (gameState.available_actions || []).forEach(action => {
          const btn = document.createElement("button");
          btn.className = "btn btn-outline-light action-btn action-" + action.type;
          btn.textContent = action.label;
          if (action.type === "talk") {
            btn.onclick = () => startChat(action.target);
          } else {
            btn.onclick = () => doAction(action);
          }
          actionsGrid.appendChild(btn);
        });
      }

      // Events
      renderEvents(gameState.events || []);

      if (gameState.phase === "game_over") {
        alert(gameState.winner_reason || "Game Over");
      }

      // Briefly show overlay when returning from chat
      showOverlayOnceIfNeeded();
    }

    function renderRole(role, canKill) {
      const dropdown = document.getElementById("role-dropdown");
      const content = document.getElementById("role-content");
      const teamLabels = { good: "Good Team", evil: "Evil Team", neutral: "Neutral Team" };
      const roleEmoji = { goose: "ü¶¢", sheriff: "üîç", vigilante: "üó°Ô∏è", canadian: "üçÅ", dodo: "ü¶§", assassin: "üéØ" };
      content.innerHTML = `
        <div class="d-flex align-items-center gap-2 mb-2">
          <div class="fs-4">${roleEmoji[role.role_type] || "‚ùì"}</div>
          <div>
            <div class="fw-semibold text-dark">${role.name}</div>
            <div class="text-dark">${teamLabels[role.team] || role.team}</div>
          </div>
        </div>
        <div class="mb-2 text-dark">${role.description}</div>
        ${canKill ? '<div class="text-dark">üî™ Can kill</div>' : ''}
      `;
      if (autoShowRole) {
        dropdown.classList.add("show");
        autoShowRole = false;
        setTimeout(() => dropdown.classList.remove("show"), 2000);
      }
    }

    function renderPlayerDetail(p) {
      const myInfo = document.getElementById("my-info");
      myInfo.innerHTML = `
        <div class="fw-bold mb-1">${p.name}</div>
        <div class="text-secondary small mb-1">Status: ${p.is_alive ? "Alive" : "Dead"}</div>
        <div class="text-secondary small mb-1">Location: ${p.location || "-"}</div>
        <div class="text-secondary small mb-1">Last Action: ${p.last_action || "Unknown"}</div>
      `;
    }

    function renderEvents(events) {
      const eventLog = document.getElementById("event-log");
      eventLog.innerHTML = "";
      (events || []).forEach(ev => {
        const div = document.createElement("div");
        div.className = "mb-2 p-2 rounded border border-secondary-subtle";
        div.textContent = ev.text;
        eventLog.appendChild(div);
      });
      eventLog.scrollTop = eventLog.scrollHeight;
    }

    document.addEventListener("DOMContentLoaded", () => {
      fetchState();
      showOverlayOnceIfNeeded();
    });
  </script>
</body>
</html>
