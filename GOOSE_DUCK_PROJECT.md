# 🦢 LLM 鹅鸭杀项目 - 开发文档

## 📋 项目概述

这是一个基于 LLM（大语言模型）的鹅鸭杀（类似狼人杀）游戏项目，作为 LLM 课程的课程项目。游戏的核心特点是：

- **LLM 驱动的 NPC**：所有 NPC 都由大语言模型控制，能够自主决策、对话、欺骗和推理
- **社交推理游戏**：玩家需要在一艘太空飞船上找出隐藏的"鸭子"（坏人），或作为鸭子消灭所有人
- **实时互动**：玩家可以与 LLM NPC 对话、讨论、投票

目前项目专注于鹅鸭杀这一社交推理玩法，突出多 Agent 博弈、欺骗与策略决策的 LLM 表达能力。

## ✅ 已完成功能

### 1. 身份系统设计 ✅

实现了完整的角色身份系统：


1. 好人(Goose)： 1.1 警长[鹅]（Sheriff[Goose]）：可以杀死所有鸟类，但如果杀掉鹅则会导致双方同时死亡。 1.2 正义使者[鹅]（Vigilante[Goose]）：仅拥有一次杀戮机会，可以杀掉任意一只鸟。1.3 加拿大鹅[鹅]（Canadian[Goose]）：当被杀死后1秒将会让仍存活的杀戮玩家自动报警。1.4 鹅（Goose）：完成任务，保住自己的性命并把鸭子票出去，无任何能力。

2. 中立：2.1 呆呆鸟（Dodo Bird）：在投票阶段被投出便获得胜利。

3. 鸭子：刺客[鸭]（Assassin[Duck]）：在会议期间，刺客可以按下“狙击”按钮并选择一个玩家猜测他的身份，如果猜对该玩家将会被刺客“枪毙”，如果猜错刺客将会“饮弹自尽”。一局游戏中刺客拥有两次“枪杀”机会。每次会议最多发动一次技能。

每个角色都有：
- 阵营归属
- 特殊能力（如果有）
- 胜利条件
- 冷却时间（杀人能力）

**实现文件**：
- `backend/models/identity.py` - 身份系统数据模型
- `settings/goose_duck/roles.yaml` - 角色配置

### 2. 房间地图系统 ✅

设计了太空飞船地图，包含 9 个房间：

```
┌─────────┬─────────┬─────────┐
│ 驾驶舱  │  通讯室 │  武器库 │
└────┬────┴────┬────┴────┬────┘
     │         │         │
┌────┴────┬────┴────┬────┴────┐
│ 氧气室  │   大厅  │  导航室 │
└────┬────┴────┬────┴────┬────┘
     │         │         │
┌────┴────┬────┴────┬────┴────┐
│ 发电室  │  餐厅   │  医疗室 │
└────┬────┴────┬────┴────┬────┘
     │         │         │
┌────┴─────────┴─────────┴────┐
│          反应堆              │
└──────────────────────────────┘
```

每个房间都有：
- 名称和描述
- 连接的房间（只能移动到相邻房间）
- 可执行的任务
- 特殊属性（是否危险、是否是会议室）

**实现文件**：
- `settings/goose_duck/map.yaml` - 地图配置
- `backend/goose_duck_game.py` - 房间管理逻辑

### 3. 游戏核心逻辑 ✅

实现了完整的游戏状态管理：

**游戏阶段（GamePhase）**
- `LOBBY` - 等待开始
- `FREE_ROAM` - 自由活动阶段
- `DISCUSSION` - 讨论阶段
- `VOTING` - 投票阶段
- `GAME_OVER` - 游戏结束

**基础动作**
- ✅ 移动到相邻房间
- ✅ 与同房间玩家对话（准备中）
- ✅ 杀人（鸭子能力）
- ✅ 报告尸体
- ✅ 召开紧急会议
- ✅ 投票放逐

**胜利条件检查**
- 好人胜利：所有鸭子被放逐或所有任务完成
- 坏人胜利：鸭子数量 ≥ 好人数量
- 中立胜利：呆呆鸟在投票阶段被放逐

**实现文件**：
- `backend/goose_duck_game.py` - 游戏核心逻辑（700+ 行）
- `backend/goose_duck_app.py` - FastAPI API 接口

### 4. 前端界面 ✅

实现了现代化的游戏 UI：

**主要界面**
- 🎮 开始界面
- 🗺️ 游戏主界面（房间、地图、动作面板）
- 📊 左侧面板（身份显示、玩家列表）
- 📝 右侧面板（迷你地图、事件日志）
- 🗣️ 讨论/投票弹窗

**界面特性**
- 太空主题设计
- 实时事件日志
- 迷你地图可视化
- 响应式布局

**实现文件**：
- `frontend/goose_duck.html` - 完整的前端界面（1000+ 行）

### 5. API 接口 ✅

实现了完整的 REST API：

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/state` | GET | 获取游戏状态 |
| `/api/start` | POST | 开始游戏 |
| `/api/action` | POST | 执行玩家动作 |
| `/api/map` | GET | 获取地图信息 |
| `/api/discussion` | GET | 获取讨论状态 |
| `/api/discussion/message` | POST | 发送讨论消息 |
| `/api/discussion/end` | POST | 结束讨论，开始投票 |
| `/api/reset` | POST | 重置游戏 |

**实现文件**：
- `backend/goose_duck_app.py` - FastAPI 路由

## 📁 项目结构

```
goose_duck/
├── backend/
│   ├── models/
│   │   ├── identity.py          # ✨ 身份系统（新增）
│   │   └── ...
│   ├── goose_duck_game.py       # ✨ 游戏核心逻辑（新增）
│   ├── goose_duck_app.py        # ✨ API 入口（新增）
│   └── __main__.py              # 启动入口（已修改）
│
├── settings/
│   └── goose_duck/              # ✨ 鹅鸭杀配置（新增）
│       ├── config.yaml          # 游戏配置
│       ├── map.yaml             # 地图配置
│       └── roles.yaml           # 角色配置
│
└── frontend/
    └── goose_duck.html          # ✨ 游戏前端（新增）
```

## 🔧 技术栈

- **后端**：FastAPI (Python)
- **前端**：原生 HTML/CSS/JavaScript
- **LLM**：OpenRouter API（支持多种模型）
- **配置**：YAML

## 🚀 运行方式

### 1. 安装依赖

```bash
cd goose_duck
pip install -r requirements.txt
```

### 2. 配置 LLM

在 `backend/.env` 文件中设置：

```env
API_KEY=your_openrouter_api_key
MODEL=x-ai/grok-3-mini-beta  # 或其他模型
```

### 3. 启动后端

```bash
python -m goose_duck.backend
```

后端将在 `http://127.0.0.1:8000` 启动。

### 4. 启动前端

```bash
python -m http.server 5173 --directory goose_duck/frontend
```

然后访问：`http://127.0.0.1:5173/goose_duck.html`

## ⏳ 下一步计划

### 第一阶段：核心玩法完善（优先级：🔥🔥🔥）

#### 1. 讨论机制实现
- [ ] **NPC 轮流发言**
  - 实现讨论阶段的发言顺序控制
  - NPC 根据游戏信息生成发言内容
  
- [ ] **LLM 发言策略**
  - 设计 Prompt 让 NPC 根据身份发言
  - 好人：分享观察、分析疑点
  - 坏人：撒谎、转移怀疑、制造不在场证明
  - 中立：根据胜利条件调整策略

- [ ] **讨论时间限制**
  - 自动结束讨论进入投票


#### 2. 投票系统完善
- [ ] **NPC 投票逻辑**
  - LLM 决定投票目标
  - 考虑讨论中的证据和发言
  - 不同身份有不同的投票策略

- [ ] **投票结果展示**
  - 显示每个人投给谁
  - 显示被放逐者的身份
  - 处理平票情况


#### 3. NPC 自主行动
- [ ] **智能移动决策**
  - NPC 根据目标决定移动
  - 坏人：寻找落单目标
  - 好人：和好人抱团、寻找目击证人、做任务

- [ ] **杀人策略**
  - 坏人选择合适的时机和地点
  - 制造不在场证明

- [ ] **任务系统**
  - 好人需要完成任务
  - 坏人可以假装做任务
  - 任务进度影响胜利条件

**预计工作量**：3-4 天

### 第二阶段：LLM 能力展示（优先级：🔥🔥）

#### 4. 高级对话系统
- [ ] **实时对话**
  - 玩家与同房间 NPC 实时对话
  - NPC 根据上下文回应

- [ ] **多 Agent 互动**
  - NPC 之间可以自动对话



### 核心亮点
1. **多 Agent 博弈**：多个 LLM 在同一环境中互动、竞争
2. **欺骗与推理**：LLM 如何学会撒谎和识别谎言
3. **策略决策**：LLM 如何做出长期策略规划
4. **社交智能**：LLM 的社交推理和说服能力

### 展示场景
1. **讨论阶段**：观看多个 LLM 互相辩论、质疑
2. **投票分析**：分析 LLM 的投票决策逻辑
3. **欺骗检测**：展示如何识别 LLM 的谎言
4. **策略对比**：对比不同身份的策略差异

## 📝 技术挑战


### 2. NPC 一致性
- **挑战**：确保 NPC 行为符合角色设定
- **解决方案**：
  - 设计详细的 Prompt 模板
  - 保存对话历史和状态
  - 定期检查和修正
